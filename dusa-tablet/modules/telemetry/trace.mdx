---
title: "Trace Engine"
description: "Core tracing engine for operation tracking"
---

# DusaTrace

`telemetry/server/trace.lua` is the core tracing engine that manages operation tracking.

## Global Table

```lua
DusaTrace = DusaTrace or {}
```

## Core API

### DusaTrace.start

Start a new trace:

```lua
local traceId = DusaTrace.start(action, initialData)
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `action` | string | Operation type (e.g., 'CREATE_ORDER', 'SEND_MESSAGE') |
| `initialData` | table? | Initial context data |

**Returns:** `traceId` string or `nil` if failed

**Example:**

```lua
local traceId = DusaTrace.start('HIRE_EMPLOYEE', {
    playerId = source,
    shopId = 5,
    employeeName = 'John Doe'
})
```

### DusaTrace.addStep

Add a step to an existing trace:

```lua
DusaTrace.addStep(traceId, stage, source, data)
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `traceId` | string | The trace ID |
| `stage` | string | Step name |
| `source` | string | Source type (SERVER, CLIENT, DATABASE, NUI) |
| `data` | table? | Step data |

**Example:**

```lua
DusaTrace.addStep(traceId, 'PERMISSION_CHECK', 'SERVER', { hasPermission = true })
DusaTrace.addStep(traceId, 'DATABASE_INSERT', 'DATABASE', { queryTime = 45 })
```

### DusaTrace.end_

End a trace with final status:

```lua
DusaTrace.end_(traceId, status, finalData)
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `traceId` | string | The trace ID |
| `status` | string | Final status ('SUCCESS' or 'ERROR') |
| `finalData` | table? | Final result data |

**Example:**

```lua
-- Success
DusaTrace.end_(traceId, 'SUCCESS', { employeeId = 123 })

-- Error
DusaTrace.end_(traceId, 'ERROR', { error = 'Permission denied' })
```

## Query API

### DusaTrace.get

Get an active trace by ID:

```lua
local trace = DusaTrace.get(traceId)
```

### DusaTrace.getActive

Get all active (in-progress) traces:

```lua
local activeTraces = DusaTrace.getActive()
-- Returns: { { traceId, action, stepCount, duration, status }, ... }
```

### DusaTrace.getStats

Get tracing statistics:

```lua
local stats = DusaTrace.getStats()
```

**Returns:**

```lua
{
    totalTraces = 150,
    activeTraces = 3,
    successCount = 140,
    errorCount = 10,
    errorRate = 0.066,
    avgDuration = 125,
    recentTraces = { ... }  -- Last 100 traces
}
```

### DusaTrace.getRecentErrors

Get recent errors for anomaly detection:

```lua
local errors = DusaTrace.getRecentErrors(windowSeconds)
-- Returns: { ['HIRE_EMPLOYEE'] = 5, ['CREATE_ORDER'] = 2 }
```

## Maintenance

### DusaTrace.cleanup

Clean up stale traces (called automatically):

```lua
local cleaned = DusaTrace.cleanup()
-- Returns: number of cleaned traces
```

### DusaTrace.resetStats

Reset statistics (for testing):

```lua
DusaTrace.resetStats()
```

## Constants

From `telemetry/shared/constants.lua`:

```lua
DusaTraceConstants = {
    STATUS = {
        PENDING = 'PENDING',
        SUCCESS = 'SUCCESS',
        ERROR = 'ERROR',
    },

    SOURCE = {
        CLIENT = 'CLIENT',
        SERVER = 'SERVER',
        DATABASE = 'DATABASE',
        NUI = 'NUI',
    },

    DEFAULTS = {
        MAX_ACTIVE_TRACES = 1000,
        MAX_STEPS_PER_TRACE = 50,
        TRACE_TIMEOUT_MS = 30000,
        CLEANUP_INTERVAL_MS = 60000,
        SLOW_OPERATION_MS = 1000,
        ERROR_RATE_THRESHOLD = 0.10,
    }
}
```

## Trace Structure

A complete trace object:

```lua
{
    traceId = '1234567890-12345',
    action = 'HIRE_EMPLOYEE',
    playerId = 1,
    startTime = 123456789,
    startTimestamp = 1705320000,
    endTime = 123456934,
    duration = 145,
    finalStatus = 'SUCCESS',
    steps = {
        {
            timestamp = 123456789,
            relativeTime = 0,
            stage = 'TRACE_STARTED',
            source = 'SERVER',
            status = 'SUCCESS',
            data = { shopId = 5 }
        },
        {
            timestamp = 123456834,
            relativeTime = 45,
            stage = 'DATABASE_INSERT',
            source = 'DATABASE',
            status = 'SUCCESS',
            data = { queryTime = 45 }
        },
        -- ...
    },
    resource = 'dusa_tablet',
    initialData = { shopId = 5 },
    finalData = { employeeId = 123 }
}
```

## Integration Pattern

### Full Operation Trace

```lua
lib.callback.register('mechanic:hireEmployee', function(source, data)
    -- Start trace
    local traceId = DusaTrace.start('HIRE_EMPLOYEE', {
        playerId = source,
        targetId = data.targetId
    })

    -- Permission check
    DusaTrace.addStep(traceId, 'PERMISSION_CHECK', 'SERVER')
    if not hasPermission(source) then
        DusaTrace.end_(traceId, 'ERROR', { error = 'No permission' })
        return { success = false }
    end
    DusaTrace.addStep(traceId, 'PERMISSION_OK', 'SERVER', { granted = true })

    -- Database insert
    DusaTrace.addStep(traceId, 'DATABASE_INSERT_START', 'DATABASE')
    local result = MySQL.insert.await(...)
    DusaTrace.addStep(traceId, 'DATABASE_INSERT_DONE', 'DATABASE', { id = result })

    -- Success
    DusaTrace.end_(traceId, 'SUCCESS', { employeeId = result })
    return { success = true, employeeId = result }
end)
```

## Automatic Alerts

When a trace ends:

- **ERROR status** → Triggers `DusaTraceAlerts.onError(trace)`
- **Duration > 1000ms** → Triggers `DusaTraceAlerts.onSlowOperation(trace)`

## Background Cleanup

Stale traces are automatically cleaned up:

```lua
CreateThread(function()
    while true do
        Wait(60000)  -- Every minute
        local cleaned = Trace.cleanup()
        if cleaned > 0 then
            print('[DusaTrace] Cleaned ' .. cleaned .. ' stale traces')
        end
    end
end)
```
