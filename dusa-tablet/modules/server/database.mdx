---
title: "Database System"
description: "Database management, migrations, and initialization"
---

# Database Module

The database system handles schema management and automatic migrations.

## Files

- `server/database/migration.lua` - Migration runner
- `server/database/init.lua` - Database initialization

## Migration System

### TabletMigration

Global table for migration management:

```lua
TabletMigration = TabletMigration or {}
```

### Running Migrations

Migrations are automatically run on resource start if `Config.Database.AutoMigration = true`:

```lua
-- Called on resource start
TabletMigration.runAll()
```

### Migration Files

Migrations are stored in `sql/migrations/` with numbered prefixes:

```
sql/migrations/
├── 001_initial_schema.sql
├── 002_add_mail_tables.sql
└── 003_add_news_tables.sql
```

### Migration Tracking

Completed migrations are tracked in the `tablet_migrations` table:

```sql
CREATE TABLE IF NOT EXISTS tablet_migrations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    migration VARCHAR(255) NOT NULL UNIQUE,
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### TabletMigration.run

Run a specific migration:

```lua
TabletMigration.run(migrationName)
```

**Example:**

```lua
TabletMigration.run('001_initial_schema.sql')
```

### TabletMigration.isExecuted

Check if a migration has been executed:

```lua
local executed = TabletMigration.isExecuted('001_initial_schema.sql')
```

## Database Initialization

### TabletDatabase

Global table for database operations:

```lua
TabletDatabase = TabletDatabase or {}
```

### Common Operations

```lua
-- Check connection
local connected = TabletDatabase.isConnected()

-- Execute query
local result = TabletDatabase.query('SELECT * FROM tablet_users WHERE id = ?', {userId})

-- Insert with ID return
local insertId = TabletDatabase.insert('tablet_users', {
    identifier = player.Identifier,
    name = player.Firstname .. ' ' .. player.Lastname
})
```

## Schema Standards

### SQL Collation

Always use `utf8mb4_general_ci`:

```sql
CREATE TABLE tablet_example (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

### Table Naming

All tables use the `tablet_` prefix:

- `tablet_users`
- `tablet_mail_threads`
- `tablet_news_articles`

## Example Migration

```sql
-- sql/migrations/004_add_camera_photos.sql

CREATE TABLE IF NOT EXISTS tablet_photos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    identifier VARCHAR(64) NOT NULL,
    url TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_identifier (identifier)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

## Manual Migration

If you need to run migrations manually:

```lua
-- In server console or script
exports['dusa_tablet']:runMigration('004_add_camera_photos.sql')
```

## Best Practices

<Tip>
Always create a migration for database changes rather than modifying existing migrations.
</Tip>

<Warning>
Never modify executed migrations. Create a new migration to alter existing tables.
</Warning>

```lua
-- WRONG: Modifying existing migration
-- 001_initial_schema.sql (modified)

-- CORRECT: New migration
-- 005_alter_users_add_phone.sql
ALTER TABLE tablet_users ADD COLUMN phone VARCHAR(20);
```
