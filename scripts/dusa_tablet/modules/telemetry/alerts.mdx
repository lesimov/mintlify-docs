---
title: "Alerts System"
description: "Discord webhooks and anomaly detection"
---

# DusaTraceAlerts

`telemetry/server/alerts.lua` handles Discord webhook alerts and anomaly detection.

## Global Table

```lua
DusaTraceAlerts = DusaTraceAlerts or {}
```

## Configuration

In `telemetry/config.lua`:

```lua
DusaTraceConfig.Alerts = {
    Enabled = true,
    DiscordWebhook = 'YOUR_DISCORD_WEBHOOK_URL',
    AnomalyDetection = true,
    SlowOperationAlerts = true,
}
```

## Alert Types

### Error Alerts

Triggered when a trace ends with ERROR status:

```lua
-- Automatic trigger
DusaTrace.end_(traceId, 'ERROR', { error = 'Database failed' })
-- ‚Üí DusaTraceAlerts.onError(trace) called automatically
```

**Discord Embed:**

```
üî¥ CRITICAL ERROR
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Resource: dusa_tablet
Operation: HIRE_EMPLOYEE
Trace ID: `1234567890-12345`

Error:
```
Database connection failed
```

Timeline:
```
‚úì TRACE_STARTED (0ms)
‚úì PERMISSION_CHECK (15ms)
‚úó DATABASE_INSERT (45ms)
```
```

### Slow Operation Alerts

Triggered when operation duration exceeds threshold (default: 1000ms):

```lua
-- Automatic trigger when duration > SLOW_OPERATION_MS
DusaTraceAlerts.onSlowOperation(trace)
```

**Discord Embed:**

```
üü° SLOW OPERATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Resource: dusa_tablet
Operation: CREATE_ORDER
Duration: 2500ms
Threshold: 1000ms

Slowest Steps:
DATABASE_SELECT: 1800ms
VALIDATION: 400ms
PERMISSION_CHECK: 200ms
```

### Anomaly Alerts

Three types of anomalies are detected:

<Tabs>
  <Tab title="High Error Rate">
    Triggered when error rate exceeds threshold (default: 10%)

    ```
    üî¥ ANOMALY DETECTED
    Error rate has exceeded threshold.

    Error Rate: 15.2% (threshold: 10.0%)
    Period: Last 5 minutes
    Total Operations: 150
    Failed: 23
    ```
  </Tab>

  <Tab title="Slow Operations">
    Triggered when average duration exceeds threshold

    ```
    üü° ANOMALY DETECTED
    Operations are running slower than expected.

    Average Duration: 1500ms (threshold: 1000ms)
    Slowest: 3200ms
    Sample Size: 50 operations
    ```
  </Tab>

  <Tab title="Error Spike">
    Triggered when many errors occur in short time window

    ```
    üî¥ ANOMALY DETECTED
    Sudden spike in errors detected.

    Error Type: HIRE_EMPLOYEE
    Count: 10 in last minute
    Threshold: 5
    ```
  </Tab>
</Tabs>

## API

### DusaTraceAlerts.init

Initialize the alert system:

```lua
DusaTraceAlerts.init()
```

Called automatically on resource start.

### DusaTraceAlerts.onError

Handle error traces:

```lua
DusaTraceAlerts.onError(trace)
```

### DusaTraceAlerts.onSlowOperation

Handle slow operations:

```lua
DusaTraceAlerts.onSlowOperation(trace)
```

### DusaTraceAlerts.onLogError

Track errors from logger (for anomaly detection):

```lua
DusaTraceAlerts.onLogError(errorData)
```

### DusaTraceAlerts.sendAnomaly

Send custom anomaly alert:

```lua
DusaTraceAlerts.sendAnomaly(anomalyType, data)
```

**Anomaly Types:**

```lua
DusaTraceConstants.ANOMALY = {
    HIGH_ERROR_RATE = 'HIGH_ERROR_RATE',
    SLOW_OPERATIONS = 'SLOW_OPERATIONS',
    ERROR_SPIKE = 'ERROR_SPIKE',
}
```

### DusaTraceAlerts.startAnomalyDetection

Start background anomaly detection:

```lua
DusaTraceAlerts.startAnomalyDetection()
```

Runs every 60 seconds checking for:
- High error rate
- Slow average operations
- Error spikes

### DusaTraceAlerts.getStatus

Get alert system status:

```lua
local status = DusaTraceAlerts.getStatus()
-- Returns: { initialized, alertsSent, lastAnomalyCheck, trackedErrorTypes }
```

## Rate Limiting

Alerts are rate-limited to prevent spam:

- Same alert type: 1 minute cooldown
- Prevents flooding Discord with repeated errors

```lua
-- Internal rate limit
local ALERT_COOLDOWN = 60  -- seconds

-- Error for HIRE_EMPLOYEE sent at 12:00:00
-- Same error at 12:00:30 ‚Üí Skipped (rate limited)
-- Same error at 12:01:00 ‚Üí Sent
```

## Discord Webhook Setup

1. **Create Webhook:**
   - Discord Server ‚Üí Settings ‚Üí Integrations ‚Üí Webhooks
   - Create Webhook ‚Üí Copy URL

2. **Configure:**
   ```lua
   DusaTraceConfig.Alerts.DiscordWebhook = 'https://discord.com/api/webhooks/...'
   ```

3. **Test:**
   ```lua
   -- Trigger test error
   local traceId = DusaTrace.start('TEST_OPERATION')
   DusaTrace.end_(traceId, 'ERROR', { error = 'Test error' })
   ```

## Discord Embed Colors

| Type | Color | Hex |
|------|-------|-----|
| Error | Red | `0xE53935` |
| Warning | Yellow | `0xFFC107` |
| Info | Blue | `0x2196F3` |
| Success | Green | `0x4CAF50` |

## Thresholds

From `DusaTraceConstants.DEFAULTS`:

```lua
SLOW_OPERATION_MS = 1000,      -- 1 second
ERROR_RATE_THRESHOLD = 0.10,   -- 10%
ERROR_RATE_WINDOW_SEC = 300,   -- 5 minutes
ERROR_SPIKE_COUNT = 5,         -- 5 errors
ERROR_SPIKE_WINDOW_SEC = 60,   -- 1 minute
```

<Tip>
Adjust thresholds based on your server's normal operation patterns. High-traffic servers may need higher thresholds.
</Tip>
